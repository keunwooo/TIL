# Thanos



### Prometheus & Thanos

```
helm repo add bitnami https://charts.bitnami.com/bitnami

helm install prometheus-operator \
  --set prometheus.thanos.create=true \
  --set operator.service.type=ClusterIP \
  --set prometheus.service.type=ClusterIP \
  --set alertmanager.service.type=ClusterIP \
  --set prometheus.thanos.service.type=LoadBalancer \
  --set prometheus.externalLabels.cluster="data-producer-0" \
  bitnami/prometheus-operator

kubectl get svc | grep prometheus-operator-prometheus-thanos

helm install thanos bitnami/thanos \
  --values values.yaml

helm install prometheus-operator \
  --set prometheus.thanos.create=true \
  --set operator.service.type=ClusterIP \
  --set prometheus.service.type=ClusterIP \
  --set alertmanager.service.type=ClusterIP \
  --set prometheus.thanos.service.type=LoadBalancer \
  --set prometheus.externalLabels.cluster="cluster2" \
  bitnami/prometheus-operator
  
```

- --set prometheus.thanos.create=true 옵션으로 prometheus 설치 시 sidecar를 포함하게 만듬



### Values.yaml

```
querier:
 stores:
  - 10.2.0.14:31420
  - 10.2.0.248:32527

query:
 service:
  type: NodePort
```

- 포트 번호는 kubectl get svc | grep prometheus-operator-prometheus-thanos 로 확인해서 기입

```
objstoreConfig: |-
  type: s3
  config:
    bucket: thanos
    endpoint: {{ include "thanos.minio.fullname" . }}.monitoring.svc.cluster.local:9000
    access_key: minio
    secret_key: KEY
    insecure: true
querier:
  stores:
    - SIDECAR-SERVICE-IP-ADDRESS-1:10901
    - SIDECAR-SERVICE-IP-ADDRESS-2:10901
bucketweb:
  enabled: true
compactor:
  enabled: true
storegateway:
  enabled: true
ruler:
  enabled: true
  alertmanagers:
    - http://prometheus-operator-alertmanager.monitoring.svc.cluster.local:9093
  config: |-
    groups:
      - name: "metamonitoring"
        rules:
          - alert: "PrometheusDown"
            expr: absent(up{prometheus="monitoring/prometheus-operator"})
minio:
  enabled: true
  accessKey:
    password: "minio"
  secretKey:
    password: "KEY"
  defaultBuckets: "thanos"
```



노드포트 명령어로 바꾸기

```
kubectl patch svc productpage -n default -p '{"spec": {"type": "NodePort"}}'
echo bookinfo productpage Webpage is http://$(curl ifconfig.me --silent):$(kubectl get -o jsonpath="{.spec.ports[0].nodePort}" svc productpage -n default)
```





### Grafana

```
helm install grafana bitnami/grafana   --set service.type=LoadBalancer --set admin.password=GRAFANA-PASSWORD --set persistence.enabled=false
```

- PVC 가 없으므로 persistence.enabled 옵션을 false로 줌





---

https://github.com/bitnami/charts/tree/master/bitnami/thanos







---

k3s 에서 helm install 시 connection refused 발생 시

```
kubectl config view --raw >~/.kube/config
```



![](https://danawalab.github.io/images/2020-03-17-Common-Dashboard/metrics.PNG)



---

```
helm show values bitnami/thanos
```

```
helm show values bitnami/prometheus-operator
```



그러면 타노스로 인해 오는 장점은 무엇인가? 기존 방식의 경우에는 프로메테우스 인스턴스 각각의 메트릭으로 모니터링 해야 하지만 타노스는 특정 그룹의 프로메테우스 인스턴스들의 지표들의 하나의 인스턴스로 처리해서 메트릭을 보여준다. 즉 두개의 인스턴스에서 수집된 메트릭을 합쳐서(merge) 해서 볼 수 있도록 해주고, 당연히 같은 모니터링 대상을 모니터링 하기 때문에 중복되는 메트릭 값이 있을 수 있는데, 이 중복 값을 제거 해주는 De-duplication 기능을 가지고 있다. 

### 오랜된 값 저장

앞에서 언급은 하지 않았지만 프로메테우스의 다른 문제점 중의 하나는 로컬 디스크를 사용하기 때문에 일정 기간이 지난 오래된 데이터는 삭제가 된다. 그래서 오래된 데이터에 대한 조회가 불가능하다. 

타노스 입장에서는 오래된 데이터 저장 문제 뿐만 아니라 여러 프로메테우스를 동시에 모니터링 하게 되면 마찬가지로 메모리와 로컬 디스크의 용량 문제로 인해서 여러 프로메테우스를 모니터링 할 수 없는 문제가 발생하는데, 이를 해결하기 위해서 타노스는 외부 스토리지를 사용한다. 

프로메테우스에서 수집된 데이타는 2시간 정도 메모리에 저장이 되었다가 로컬 디스크로 덤프가 된다. 저장된 파일을 타노스 에이전트가 수집해서 외부 스토리지에 저장한다. 외부 스토리지는 Ceph와 같은 분산형 파일 시스템이나 Google Cloud Storage, AWS S3와 같은 클라우드 오브젝트 스토리지를 사용한다. 

그리고 쿼리 엔진에서 근래의 데이타를 조회할때는 프로메테우스 인스턴스에 설치된 타노스 사이드카 에이전트를 통하지만 오래된 데이터는 스토리지에 저장된 데이터는 Thano Storage Gateway라는 컴포넌트를 통해서 조회된다. 이 컴포넌트는 스토리지에 저장된 데이타를 Storage API를 통해서 쿼리엔진과 통신 하는 역할을 한다. Gateway는 단순 쿼리를 API로 저장하는 역할뿐만 아니라 중간에 캐쉬를 제공하여, 빠른 응답 시간을 제공한다. 



출처: https://bcho.tistory.com/1375 [조대협의 블로그]

![](https://t1.daumcdn.net/cfile/tistory/99FC07365E3EC46126)

프로메테우스 - 내부저장소 TSDB /

타노스 - 외부 저장소



