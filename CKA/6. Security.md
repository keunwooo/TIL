# Security

kube-api 서버에 사용된 인증서 파일 확인하기

```
cat /etc/kubernetes/manifests/kube-apiserver.yaml

--tls-cert-file=/etc/kubernetes/pki/apiserver.crt 확인
```



Identify the Certificate file used to authenticate `kube-apiserver` as a client to `ETCD` Server

```
- --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt 확인
```



Identify the key used to authenticate `kubeapi-server` to the `kubelet` server

```
--kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key
```



Identify the ETCD Server Certificate used to host ETCD server

```
/etc/kubernetes/manifests/etcd.yaml

- --cert-file=/etc/kubernetes/pki/etcd/server.crt 확인
```



ETCD 서버를 제공하는 데 사용되는 ETCD 서버 CA 루트 인증서 식별

ETCD는 자체 CA를 가질 수 있습니다. 따라서 이것은 kube-api 서버에서 사용하는 것과 다른 CA 인증서일 수 있습니다.

```
/etc/kubernetes/manifests/etcd.yaml

trusted-ca-file 확인
--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
```



What is the Common Name (CN) configured on the Kube API Server Certificate?

Kube API 서버 인증서에 구성된 CN(일반 이름)은 무엇입니까?

```
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text
```

ook for Subject CN.

```
Subject: CN = kube-apiserver
```



What is the name of the CA who issued the Kube API Server Certificate?

look for issuer

```
Issuer: CN = kubernetes
```



다음 중 Kube API 서버 인증서에 구성되지 않은 대체 이름은 무엇입니까?

ook at Alternative Names

```
X509v3 Subject Alternative Name: 
                DNS:controlplane, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address:10.24.232.9
```



What is the Common Name (CN) configured on the ETCD Server certificate?

ETCD 서버 인증서에 구성된 CN(일반 이름)은 무엇입니까?

```
openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -text

Subject: CN = controlplane
```



발급일로부터 Kube-API 서버 인증서의 유효 기간은 얼마입니까?

```
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text
```

check on the Expiry date.

```

```

발급일로부터 루트 CA 인증서의 유효 기간은 얼마입니까?

```
openssl x509 -in /etc/kubernetes/pki/ca.crt -text
```



Kubectl이 갑자기 명령에 응답하지 않습니다. 확인 해봐! 누군가 최근에 /etc/kubernetes/manifests/etcd.yaml 파일을 수정했습니다.

문제를 조사하고 수정하라는 요청을 받았습니다. 문제를 해결하면 kubectl이 응답할 때까지 기다리십시오. ETCD 컨테이너의 로그를 확인하십시오.

조사결과

crt 파일이 incorrect 하다.

 It is set to `/etc/kubernetes/pki/etcd/server-certificate.crt` which does not exist. 라고 한다.

이전 질문에서 보았듯이 올바른 경로는 /etc/kubernetes/pki/etcd/server.crt여야 합니다.



```
ls -l /etc/kubernetes/pki/etcd/server* | grep .crt

root@controlplane:~# ls -l /etc/kubernetes/pki/etcd/server* | grep .crt
-rw-r--r-- 1 root root 1188 Sep 15 11:48 /etc/kubernetes/pki/etcd/server.crt
```



```
vi /etc/kubernetes/manifests/etcd.yaml
```

들어가서

```
- --cert-file=/etc/kubernetes/pki/etcd/server.crt 로 수정
```



kube-api 서버가 다시 중지되었습니다! 확인 해봐. kube-api 서버 로그를 검사하고 근본 원인을 식별하고 문제를 해결합니다.

docker ps -a 명령을 실행하여 kube-api 서버 컨테이너를 식별합니다.

 docker logs container-id 명령을 실행하여 로그를 봅니다.



```
/etc/kubernetes/manifests/kube-apiserver.yaml
```



controlplane에서 kube-apiserver 컨테이너를 검사하면 자주 종료되는 것을 알 수 있습니다.

```
root@controlplane:~# docker logs 8af74bd23540  --tail=2
W0520 01:57:23.333002       1 clientconn.go:1223] grpc: addrConn.createTransport failed to connect to {https://127.0.0.1:2379  <nil> 0 <nil>}. Err :connection error: desc = "transport: authentication handshake failed: x509: certificate signed by unknown authority". Reconnecting...
Error: context deadline exceeded
root@controlplane:~# 
```

이는 kube-apiserver에서 사용하는 ETCD CA 인증서에 문제가 있음을 나타냅니다.



ETCD에는 자체 CA가 있습니다. /etc/kubernetes/manifests/kube-apiserver.yaml의 ETCD-CA 파일에 올바른 CA를 사용해야 합니다.

```
--etcd-cafile=/etc/kubernetes/pki/ca.crt
--etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
```

