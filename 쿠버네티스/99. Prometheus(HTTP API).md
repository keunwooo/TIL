# Prometheus HTTP API

| origin_ |      |
| ------- | ---- |
|         |      |

```
origin_prometheus	
label_values(origin_prometheus)

Node	label_values(kube_node_info{origin_prometheus=~"$origin_prometheus"},node)
-> kube_node_info 조회 중 node 레이블 


NameSpace	label_values(kube_namespace_labels{origin_prometheus=~"$origin_prometheus"},namespace)

Container
label_values(kube_pod_container_info{origin_prometheus=~"$origin_prometheus",namespace=~"$NameSpace"},container)

Pod
label_values(kube_pod_container_info{origin_prometheus=~"$origin_prometheus",namespace=~"$NameSpace",container=~"$Container"},pod)
```



Api server 관련 수집  Metric 정보

https://docs.signalfx.com/en/latest/integrations/agent/monitors/kubernetes-apiserver.html

Node 정보

https://docs.signalfx.com/en/latest/integrations/agent/monitors/prometheus-node.html



**Latency:** Latency can be extracted from the `apiserver_request_duration_seconds` histogram buckets:

**Request rate:** The metric ***apiserver_request_total\*** can be used to monitor the requests to the service, from where they are coming, to which service, which action and whether they were successful

```

```



---

cpu(%) 과정 (그라파나 대시보드에서)

```
namespace: pod kube_pod_labels{cluster="cluster1"}
-> kube-system, default, local-path-storage
```

```
pod: kube_pod_info{namespace="kube-system, default, local-path-storage"}
-> prometheus-kube-state-metrics-5786c7446c-cnprd
```

```
sum(rate(container_cpu_usage_seconds_total{pod="prometheus-kube-state-metrics-5786c7446c-cnprd"}[5m]))
-> Pod 정보 얻기 
```

```
sum by(pod) (rate(container_cpu_usage_seconds_total[5m]))
```



Pod 중 prometheus-kube-state-metrics-5786c7446c-cnprd 를 얻는다. 조사 필요

```
sum by(pod) (rate(container_cpu_usage_seconds_total[5m]))
```



---

inode 구하는 방법 참고 

https://www.robustperception.io/filesystem-metrics-from-the-node-exporter



latency 및 다른 쿼리문 참고

https://cf-for-k8s.io/docs/platform_operators/networking/networking-metrics-and-monitoring/



---

쿼리문 정리



Cluster



Node



Pod

```
round(sum by (namespace, pod) (irate(container_cpu_usage_seconds_total{job="kubelet", pod!="", image!=""}[5m])) * on (namespace, pod) group_left(owner_kind, owner_name) kube_pod_owner{$1} * on (namespace, pod) group_left(node) kube_pod_info{$2}, 0.001)
```

```
sum by (namespace, pod) (container_memory_usage_bytes{job="kubelet", pod!="", image!=""}) * on (namespace, pod) group_left(owner_kind, owner_name) kube_pod_owner{$1} * on (namespace, pod) group_left(node) kube_pod_info{$2}
```

```
sum by (namespace, pod) (container_memory_working_set_bytes{job="kubelet", pod!="", image!=""}) * on (namespace, pod) group_left(owner_kind, owner_name) kube_pod_owner{$1} * on (namespace, pod) group_left(node) kube_pod_info{$2}
```

```
sum by (namespace, pod) (irate(container_network_transmit_bytes_total{pod!="", interface!~"^(cali.+|tunl.+|dummy.+|kube.+|flannel.+|cni.+|docker.+|veth.+|lo.*)", job="kubelet"}[5m])) * on (namespace, pod) group_left(owner_kind, owner_name) kube_pod_owner{$1} * on (namespace, pod) group_left(node) kube_pod_info{$2}
```

```
sum by (namespace, pod) (irate(container_network_receive_bytes_total{pod!="", interface!~"^(cali.+|tunl.+|dummy.+|kube.+|flannel.+|cni.+|docker.+|veth.+|lo.*)", job="kubelet"}[5m])) * on (namespace, pod) group_left(owner_kind, owner_name) kube_pod_owner{$1} * on (namespace, pod) group_left(node) kube_pod_info{$2}
```



```
sum by (namespace, pod) (container_memory_usage_bytes{job="kubelet", pod!="", image!=""})
*
on (namespace, pod) group_left(owner_kind, owner_name) kube_pod_owner{$1}
*
on (namespace, pod) group_left(node) kube_pod_info{$2}
```



---



| 속도를 나타내는 단위 bps에 대한 용량 환산 |                                     |                 |                                     |
| ----------------------------------------- | ----------------------------------- | --------------- | ----------------------------------- |
| 1bps                                      | 1/8cps = 0.125cps                   | 0.125Byte       | 0.125B/s                            |
| 8bps                                      | 8/8cps = 1cps                       | 1Byte           | 1B/s                                |
| 1kbps                                     | 1000/8cps = 125cps                  | 125Byte         | 0.125KB/s                           |
| 10Mbps                                    | 10,000,000/8cps = 1,250,000cps      | 1,250,000Byte   | 1,250 KB/s = 1.25MB/s               |
| 1Gbps                                     | 1,000,000,000/8cps = 125,000,000cps | 125,000,000Byte | 125,000 KB/s = 125 MB/s = 0.125GB/s |



출처: https://serpiko.tistory.com/497 [삽SAP(Study And Programming) 질 블로그. by허정진]